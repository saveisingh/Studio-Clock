var $jscomp={scope:{},owns:function(a,c){return Object.prototype.hasOwnProperty.call(a,c)}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,c,d,e){if(c){d=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var b=a[e];b in d||(d[b]={});d=d[b]}a=a[a.length-1];e=d[a];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Object.assign",function(a){return a?a:function(a,d){for(var c=1;c<arguments.length;c++){var b=arguments[c];if(b)for(var f in b)$jscomp.owns(b,f)&&(a[f]=b[f])}return a}},"es6-impl","es3");
$jscomp.checkStringArgs=function(a,c,d){if(null==a)throw new TypeError("The 'this' value for String.prototype."+d+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+d+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,d){var c=$jscomp.checkStringArgs(this,a,"startsWith");a+="";for(var b=c.length,f=a.length,h=Math.max(0,Math.min(d|0,c.length)),g=0;g<f&&h<b;)if(c[h++]!=a[g++])return!1;return g>=f}},"es6-impl","es3");$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,d){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,d||0)}},"es6-impl","es3");var mySection="webclient",mqttSection="mqtt";
config=new ConfigIniParser;var mqtt,reconnectTimeout,reconnect,host,port,clientId,username,password,weatherTopic,indicatorTopic,radioTopic,kodiTopic,commandTopic,kodiPlaybackState=0,latitude,longitude,locale=Intl.DateTimeFormat().resolvedOptions().locale,timezoneLong=Intl.DateTimeFormat().resolvedOptions().timeZone,i18n,updateLighting;
function dayPhase(a,c){for(var d=[["nightEnd","astronomical"],["nauticalDawn","nautical"],["blueHourDawn","nautical_blue"],["dawn","civil_blue"],["blueHourDawnEnd","civil"],["sunrise","horizon"],["sunriseEnd","golden"],["goldenHourEnd","daylight"],["goldenHour","golden"],["sunsetStart","horizon"],["sunset","civil"],["blueHourDusk","civil_blue"],["dusk","nautical_blue"],["blueHourDuskEnd","nautical"],["nauticalDusk","astronomical"],["night","night"]],e=["night","night"],b=0;b<d.length;b++){var f=c[d[b][0]];
null!==f&&a>=f&&(e=d[b])}return e[1]}
function getLighting(a){var c={daylight:{fullName:i18n.__("Daylight"),shortName:"daylight",backgroundColor:"#85a8c3",textColor:"rgba(0,0,0,0.75)"},golden:{fullName:i18n.__("Golden hour"),shortName:"golden",backgroundColor:"#aa8a62",textColor:"rgba(0,0,0,0.75)"},horizon:{fullName:i18n.__("Sunrise/Sunset"),shortName:"horizon",backgroundColor:"#912d25",textColor:"rgba(255,255,255,0.75)"},civil:{fullName:i18n.__("Civil Twilight"),shortName:"civil",backgroundColor:"#a19e9f",textColor:"rgba(0,0,0,0.75)"},
civil_blue:{fullName:i18n.__("Civil Twilight (Blue hour)"),shortName:"civil_blue",backgroundColor:"#979598",textColor:"rgba(0,0,0,0.75)"},nautical:{fullName:i18n.__("Nautical Twilight"),shortName:"nautical",backgroundColor:"#103980",textColor:"rgba(255,255,255,0.75)"},nautical_blue:{fullName:i18n.__("Nautical Twilight (Blue hour)"),shortName:"nautical_blue",backgroundColor:"#103980",textColor:"rgba(255,255,255,0.75)"},astronomical:{fullName:i18n.__("Astronomical Twilight"),shortName:"astronomical",
backgroundColor:"#101e31",textColor:"rgba(255,255,255,0.75)"},night:{fullName:i18n.__("Night"),shortName:"night",backgroundColor:"#0d121f",textColor:"rgba(255,255,255,0.75)"},unknown:{fullName:"",shortName:"unknown",backgroundColor:"#ffffff",textColor:"rgba(0,0,0,0.75)"}};void 0===a&&(a=new Date);var d=SunCalc.getTimes(a,latitude,longitude);a=dayPhase(a,d);return c[a]}function date2HHmm(a){var c={hour:"2-digit",minute:"2-digit",timeZone:timezoneLong};return a?a.toLocaleString(locale,c):""}
function HHmm2date(a){a=a.split(":");return 2===a.length?(hour=parseInt(a[0],10),minute=parseInt(a[1],10),second=0,date=new Date(null,null,null,hour,minute,second)):null}function HHmm2HHmm(a){return(a=HHmm2date(a))?date2HHmm(a):""}function numberCheck(a){return!isNaN(a)}
function unitConvert(a,c,d,e){function b(a,c){var b=Math.pow(10,c);return Math.round(a*b)/b}e=void 0===e?0:e;var f={mm:{to:function(a){return a/1E3},from:function(a){return 1E3*a}},cm:{to:function(a){return a/100},from:function(a){return 100*a}},m:{to:function(a){return a},from:function(a){return a}},"in":{to:function(a){return a/39.37007874},from:function(a){return 39.37007874*a}},ft:{to:function(a){return a/3.280839895},from:function(a){return 3.280839895*a}}},h={K:{to:function(a){return a},from:function(a){return a}},
C:{to:function(a){return a+273.15},from:function(a){return a-273.15}},F:{to:function(a){return 5*(a+459.67)/9},from:function(a){return 9*a/5-459.67}}},g={"m/s":{to:function(a){return a},from:function(a){return a}},"km/h":{to:function(a){return a/3.6},from:function(a){return 3.6*a}},mph:{to:function(a){return a/2.236936},from:function(a){return 2.236936*a}}},k={Pa:{to:function(a){return a},from:function(a){return a}},bar:{to:function(a){return 1E5*a},from:function(a){return a/1E5}},mbar:{to:function(a){return 100*
a},from:function(a){return a/100}},hPa:{to:function(a){return 100*a},from:function(a){return a/100}},mmHg:{to:function(a){return 133.322387415*a},from:function(a){return a/133.322387415}},inHg:{to:function(a){return 3386.39*a},from:function(a){return a/3386.39}}},l=Object.assign({},f,h,g,k);return l.hasOwnProperty(c)&&l.hasOwnProperty(d)?f.hasOwnProperty(c)&&f.hasOwnProperty(d)?b(f[d].from(f[c].to(a)),e):h.hasOwnProperty(c)&&h.hasOwnProperty(d)?b(h[d].from(h[c].to(a)),e):g.hasOwnProperty(c)&&g.hasOwnProperty(d)?
b(g[d].from(g[c].to(a)),e):k.hasOwnProperty(c)&&k.hasOwnProperty(d)?b(k[d].from(k[c].to(a)),e):a:a}function setElement(a,c,d){d=void 0===d?"":d;if(a=document.getElementById(a))a.innerHTML=c?c:d}function setProgress(a,c){var d=document.getElementById(a);if(d){var e=d.parentNode.clientWidth,b=d.parentNode.clientHeight,f=e/100*Number(c);f>e&&(f=e);d.style.width=f.toString()+"px";d.style.height=b+"px"}}function setPlayerIcon(a,c){var d=document.getElementById(a);d&&(d.className="fa fa-"+c)}
function setLighting(a){a||(a=new Date);var c=getLighting(a),d=SunCalc.getTimes(a,latitude,longitude),e=SunCalc.getMoonTimes(a,latitude,longitude),b=SunCalc.getMoonIllumination(a);a=b.age;var b=Math.round(100*b.fraction),f=document.getElementById("lighting/moonage");f&&(f.innerHTML="",f.className="wi wi-moon-"+a.toString());setElement("lighting/moonpercent",b,"0");console.log("Current lighting condition: "+c.fullName);setElement("lighting/fullname",c.fullName);setElement("lighting/sunrise",date2HHmm(d.sunrise));
setElement("lighting/noon",date2HHmm(d.solarNoon));setElement("lighting/sunset",date2HHmm(d.sunset));e.set?setElement("lighting/moonset",date2HHmm(e.set)):setElement("lighting/moonset","—");e.rise?setElement("lighting/moonrise",date2HHmm(e.rise)):setElement("lighting/moonrise","—");e.alwaysDown&&(setElement("lighting/moonset",i18n.__("always")),setElement("lighting/moonrise","—"));e.alwaysUp&&(setElement("lighting/moonset","—"),setElement("lighting/moonrise",i18n.__("always")));setElement("lighting/blueHourDawn/begin",
date2HHmm(d.blueHourDawn));setElement("lighting/blueHourDawn/end",date2HHmm(d.blueHourDawnEnd));setElement("lighting/blueHourDusk/begin",date2HHmm(d.blueHourDusk));setElement("lighting/blueHourDusk/end",date2HHmm(d.blueHourDuskEnd));setElement("lighting/goldenHourDawn/begin",date2HHmm(d.sunriseEnd));setElement("lighting/goldenHourDawn/end",date2HHmm(d.goldenHourEnd));setElement("lighting/goldenHourDusk/begin",date2HHmm(d.goldenHour));setElement("lighting/goldenHourDusk/end",date2HHmm(d.sunsetStart));
document.documentElement.style.backgroundColor=c.backgroundColor;document.documentElement.style.color=c.textColor;document.documentElement.style.backgroundImage="url('images/"+c.shortName+".jpg')"}function shorten(a,c){c=void 0===c?weatherTopic:c;return a.replace(c,"")}function shortest(a){return a.split("/").pop()}
function onConnect(){console.log("Connected to broker "+host+":"+port+" as user '"+username+"'");console.log("Subscribing to weather status at "+weatherTopic+"#");mqtt.subscribe(weatherTopic+"#");console.log("Subscribing to radio status at "+radioTopic+"#");mqtt.subscribe(radioTopic+"#");console.log("Subscribing to studio status at "+indicatorTopic+"#");mqtt.subscribe(indicatorTopic+"#");console.log("Subscribing to Kodi status at "+kodiTopic+"#");mqtt.subscribe(kodiTopic+"#");console.log("Subscribing to device command at "+
commandTopic+"#");mqtt.subscribe(commandTopic+"#")}function onFailure(a){console.log("Connection to "+host+":"+port+" as user '"+username+"' failed");setTimeout(MQTTconnect,reconnectTimeout)}
function onMessageArrived(a){out_msg=a.destinationName+": "+a.payloadString;console.log(out_msg);var c=shorten(a.destinationName),d=shortest(a.destinationName);"latitude"==c&&(latitude=Number(a.payloadString));"longitude"==c&&(longitude=Number(a.payloadString));"local_tz_long"==c&&(timezoneLong=a.payloadString);a.destinationName.startsWith(commandTopic)&&(c=shorten(a.destinationName,commandTopic),["reload"].includes(c)?(console.log("RELOADING ..."),window.location.reload(!0)):console.log("Ignoring unknown command "+
c));if(a.destinationName.startsWith(kodiTopic)){if(c=shorten(a.destinationName,kodiTopic),["title","playbackstate","progress"].includes(c))switch(a=JSON.parse(a.payloadString),c){case "title":0<kodiPlaybackState&&(setElement("kodi/title",a.val," "),c=a.kodi_details.type.charAt(0).toUpperCase()+a.kodi_details.type.slice(1),setElement("kodi/title/type",i18n.__(c)),setElement("kodi/title/label",a.kodi_details.label));break;case "playbackstate":kodiPlaybackState=a.val;0>=kodiPlaybackState&&(setPlayerIcon("kodi/state",
"stop"),setElement("kodi/title",""),setElement("kodi/title/type",""),setElement("kodi/title/label",""),setProgress("kodi/progress","0"));1==kodiPlaybackState?setPlayerIcon("kodi/state","play"):2==kodiPlaybackState&&setPlayerIcon("kodi/state","pause");break;case "progress":0<kodiPlaybackState&&setProgress("kodi/progress",a.val)}}else if(a.destinationName.startsWith(radioTopic))c=shorten(a.destinationName,radioTopic),["title"].includes(c)?setElement("radio/status/"+c,a.payloadString," "):setElement("radio/status/"+
c,a.payloadString);else{if(a.destinationName.startsWith(indicatorTopic)){var e=shorten(a.destinationName,indicatorTopic),b=document.getElementById("studio/status/"+e);if(b){if("white green yellow red blue switch".split(" ").includes(e))switch(a.payloadString){case "on":console.log(e+": "+a.payloadString);b.classList.contains("flash")&&b.classList.remove("flash");b.classList.contains("blink")&&b.classList.remove("blink");b.classList.contains("on")||b.classList.add("on");break;case "off":console.log(e+
": "+a.payloadString);b.classList.contains("flash")&&b.classList.remove("flash");b.classList.contains("blink")&&b.classList.remove("blink");b.classList.contains("on")&&b.classList.remove("on");break;case "flash":console.log(e+": "+a.payloadString);b.classList.contains("on")&&b.classList.remove("on");b.classList.contains("blink")&&b.classList.remove("blink");b.classList.contains("flash")||b.classList.add("flash");break;case "blink":console.log(e+": "+a.payloadString),b.classList.contains("on")&&b.classList.remove("on"),
b.classList.contains("flash")&&b.classList.remove("flash"),b.classList.contains("blink")||b.classList.add("blink")}else b.innerHTML=a.payloadString;return}}if(b=document.getElementById(c)){b.innerHTML=a.payloadString;"winddirection"==d&&(b.innerHTML="",b.className="wi wi-wind from-"+a.payloadString+"-deg");"icon"==d&&(b.innerHTML="",b.className="wi wi-wu-"+a.payloadString);["temperature","feelslike"].includes(c)&&(b.innerHTML=unitConvert(Number(a.payloadString),"C",i18n.__(".temperature"),1).toLocaleString(locale));
["pressure"].includes(c)&&(b.innerHTML=unitConvert(Number(a.payloadString),"hPa",i18n.__(".pressure"),Number(i18n.__(".pressure_decimals"))).toLocaleString(locale));["elevation"].includes(c)&&(b.innerHTML=unitConvert(Number(a.payloadString),"m",i18n.__(".elevation")).toLocaleString(locale));["temperature_low","temperature_high"].includes(d)&&(b.innerHTML=unitConvert(Number(a.payloadString),"C",i18n.__(".temperature")).toLocaleString(locale));["windspeed","windspeed_max"].includes(d)&&(b.innerHTML=
unitConvert(Number(a.payloadString),"km/h",i18n.__(".speed"),Number(i18n.__(".speed_decimals"))).toLocaleString(locale));["precipitation"].includes(d)&&(numberCheck(a.payloadString)?b.innerHTML=unitConvert(Number(a.payloadString),"mm",i18n.__(".precipitation"),Number(i18n.__(".precipitation_decimals"))).toLocaleString(locale):b.innerHTML="–");["snow"].includes(d)&&(numberCheck(a.payloadString)?b.innerHTML=unitConvert(Number(a.payloadString),"cm",i18n.__(".snowfall"),Number(i18n.__(".snowfall_decimals"))).toLocaleString(locale):
b.innerHTML="–");if(["humidity","pop","uv"].includes(d)&&(b.innerHTML=Number(a.payloadString).toLocaleString(locale),"uv"==d))switch(e=Number(a.payloadString),!0){case 11<=e:b.className="uv-color uv-color-purple";b.title=i18n.__("Risk: Extreme");break;case 8<=e:b.className="uv-color uv-color-red";b.title=i18n.__("Risk: Very high");break;case 6<=e:b.className="uv-color uv-color-orange";b.title=i18n.__("Risk: High");break;case 3<=e:b.className="uv-color uv-color-yellow";b.title=i18n.__("Risk: Moderate");
break;case 0<=e:b.className="uv-color uv-color-green";b.title=i18n.__("Risk: Low");break;default:b.className="uv-color uv-color-none",b.title=""}["wind_dir","weather"].includes(d)&&(b.innerHTML=i18n.__(a.payloadString));if("observation_epoch"==c){var e=new Date(1E3*Number(a.payloadString)),f={weekday:"short",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",timeZoneName:"short",timeZone:timezoneLong};b.innerHTML=e.toLocaleString(locale,f)}["sunrise","sunset","moonrise",
"moonset"].includes(c)&&(b.innerHTML=HHmm2HHmm(a.payloadString));"epoch"==d&&(e=new Date(1E3*Number(a.payloadString)),f={weekday:"long",timeZone:timezoneLong},b.innerHTML=e.toLocaleString(locale,f))}}}function onConnectionLost(a){console.log("Lost connection to "+a.uri+" ("+a.errorCode.toString()+")");a.reconnect?console.log("Automatic reconnect is active."):console.log("No automatic reconnect will be attempted.")}
function MQTTconnect(){console.log("Connecting to "+host+":"+port);mqtt=new Paho.MQTT.Client(host,port,clientId);var a={userName:username,password:password,timeout:3,reconnect:reconnect,onSuccess:onConnect,onFailure:onFailure};mqtt.onConnectionLost=onConnectionLost;mqtt.onMessageArrived=onMessageArrived;mqtt.connect(a)}var configfile=location.hostname?"config/"+location.hostname+".cfg":"config/unknown_host.cfg";console.log("Read configuration from "+configfile);fetch(configfile,{cache:"reload",mode:"no-cors"}).then(function(a){return a.text()}).then(function(a){return init1(a)});
function init1(a){console.log("Init stage 1: Configuration");config.parse(a);reconnectTimeout=config.getNumber(mySection,"reconnect_timeout");reconnect=config.getBoolean(mySection,"reconnect");host=config.get(mqttSection,"host");port=config.getNumber(mqttSection,"websockets_port");clientId=config.get(mySection,"client_id");username=config.get(mqttSection,"username");password=config.get(mqttSection,"password");weatherTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"weather_topic");
indicatorTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"indicator_topic");radioTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"radio_topic");kodiTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"kodi_topic");commandTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"client_topic")+"command/";latitude=config.getNumber(mySection,"latitude");longitude=config.getNumber(mySection,"longitude");timezoneLong=config.get(mySection,"timezone");locale=
config.get(mySection,"locale");document.title=config.get(mySection,"title");setElement("title",config.get(mySection,"title"));fetch("config/lang-"+locale+".json",{cache:"reload",mode:"no-cors"}).then(function(a){return a.json()}).then(function(a){return init2(a)})}
function init2(a){console.log("Init stage 2: Localization");i18n=window.i18n();i18n.loadJSON(a,"messages");i18n.setLocale(locale);a=".temperature .speed .pressure .precipitation .snowfall .elevation".split(" ");for(i=0;i<a.length;i++){var c=document.getElementsByClassName(a[i]);for(j=0;j<c.length;j++)c[j].innerHTML=i18n.__(a[i]+"_text")}c=document.getElementsByClassName("i18n");for(i=0;i<c.length;i++)c[i].innerHTML=i18n.__(c[i].innerHTML);updateLighting=setInterval(function(){setLighting()},6E4);
MQTTconnect();setLighting()};
